<!DOCTYPE html>
<html>

<head>
    {{.Head}}
    <title>Edit {{.Data.Filename}} - mdwiki</title>
</head>

<body class="markdown-body">
{{.Menu}}
<div class="wrap container">
    <div class="row">
        <div class="col-xs-12">
            <h1>Edit {{.Data.Filename}}</h1>
            <form id="edit-form">
                <div id="validation" class="hidden warning-box"></div>
                <pre id="editor" class="editor" contenteditable="true">{{.Data.RawContent}}</pre>
                <input id="filename" type="text" name="filename" value="{{.Data.Filename}}"/><br/>
                <br/>
                <button id="save" type="submit">Save</button>
                <a href="/{{.Data.Filename}}">Cancel</a>
            </form>
            <script type="module">
                ui.dom.onLoad(function () {
                    const editor = ui.dom.el('#editor')
                    editor.focus()
                    ui.dom.onKey("#editor", function (e) {
                        if (e.keyCode == 9) {
                            e.preventDefault()
                            document.execCommand('insertHTML', false, '&#009');
                        }
                    })
                    ui.dom.onPaste("#editor", function (e) {
                        e.preventDefault();
                        const text = e.clipboardData.getData("text/plain");
                        document.execCommand("insertText", false, text);
                    })
                    ui.dom.onClick("#save", function (e) {
                        e.preventDefault();
                        ui.api.post("/api/page.update/{{.Data.Filename}}", {
                            filename: ui.dom.el("#filename").value,
                            content: editor.innerText
                        })
                            .then(data => {
                                ui.dom.hide("#validation")
                                ui.browser.redirect(data.redirect)
                            })
                            .catch(error => {
                                ui.dom.content("#validation", `⚠️${error}`)
                                ui.dom.show("#validation")
                            });
                    })
                });
            </script>
            {{.Footer}}
        </div>
    </div>
</div>
</body>

</html>